// oled_image.c
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <linux/i2c-dev.h>
#include <sys/ioctl.h>
#include <unistd.h>
#include <errno.h>

#define I2C_DEVICE "/dev/i2c-1"
#define SSD1306_ADDR 0x3C
#define WIDTH 128
#define HEIGHT 32

int i2c_fd = -1;

/* --- Bitmap: hanuman rotated 270 deg (128x32 -> 512 bytes) --- */
const uint8_t hanuman_bitmap_rot270[512] = {
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF8,0x00,0x00,0x01,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0x0F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,
0x1C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x03,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFE,0x03,0x00,0x00,0x03,0x80,0x60,0x39,0x7E,0x00,0x01,0xC0,
0x18,0x00,0x00,0x01,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF0,0xDF,0xFF,0xFF,0xF8,0x00,
0x00,0x00,0x01,0xE3,0x00,0x02,0xC0,0x00,0x00,0x00,0x00,0x00,0xFD,0x7F,0xFF,0xFF,
0xFF,0xFF,0xFF,0xF8,0x5F,0xF7,0xFF,0xFF,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x3F,0xF3,0xFF,0xFF,0xFF,0xFF,0xFF,0xF8,0x5F,0xFF,0xFF,0xFF,
0xE0,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0B,0xEF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xF8,0x5F,0xFF,0xFF,0x7F,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x70,0x00,0x04,0x0B,0xFF,0x7F,0xFF,0xFF,0xFF,0xFF,0xF8,0x5F,0xFF,0x06,0x7F,
0xFF,0xC1,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0xB0,0x00,0x0F,0x0D,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xE0,0x5F,0xFE,0x0C,0x07,0xFF,0xFF,0xF0,0x00,0x00,0x00,0x00,0x00,
0x0C,0x38,0x2B,0xFF,0xFF,0xFB,0xFF,0xFF,0xFF,0xFF,0xFF,0x80,0x5F,0xFC,0x19,0x8F,
0xFF,0xFF,0xFC,0x00,0x02,0x00,0x00,0x98,0x7C,0x1C,0x3F,0xFF,0xFF,0xF7,0xFF,0xFF,
0xFF,0xFF,0xFE,0x78,0x3F,0xFC,0x3A,0xCF,0x30,0xFF,0xFF,0xF8,0x00,0x00,0x0B,0x0F,
0xF8,0x18,0x1F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF0,0x5F,0xF8,0x7A,0x3F,
0x10,0x0F,0xFF,0xFF,0x00,0x00,0x3F,0xFF,0xFC,0x18,0x16,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xF0,0x7F,0xF0,0xFF,0x7F,0xF0,0x00,0xFF,0xFF,0xF0,0x00,0xBF,0x81,
0xF8,0x78,0x1F,0xFF,0xE1,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xE0,0x3F,0xC1,0x0C,0x3F,
0xE0,0x00,0x07,0xFF,0xFF,0x1F,0x00,0x01,0xE0,0xFC,0x3F,0xFF,0xFC,0x7F,0xFF,0xFF,
0xFF,0xFF,0xFF,0xC0,0xBF,0x03,0x0F,0xFF,0xFC,0x00,0x00,0xFF,0xFF,0xF2,0x80,0x01,
0xE0,0x4D,0xFF,0xFF,0xFF,0xCF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x7F,0x07,0xFF,0xFF,
0xFF,0xC0,0x00,0x07,0xFC,0x01,0x80,0x01,0xC0,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xF8,0x00,0x7E,0x1F,0xFF,0xFF,0xFF,0xF8,0x00,0x00,0x00,0x01,0x80,0x3F,
0xF9,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x80,0x02,0xFC,0x1F,0xFF,0xFF,
0xFF,0xFF,0x80,0x00,0x00,0x01,0x03,0xFF,0x1F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFE,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x0F,0xF8,0x00,0x00,0x01,0xF1,0xC0,
0x7F,0xE0,0x01,0xFF,0xFF,0xFF,0xFF,0xFE,0xFF,0xFC,0x00,0x01,0xFF,0xC0,0x00,0x00,
0x00,0x00,0xFF,0x80,0x00,0x90,0x08,0x00,0x2F,0x00,0x01,0xFF,0xFF,0xFF,0xFF,0xFC,
0xFF,0xF0,0x00,0x0F,0xFF,0xC0,0x00,0x00,0x00,0x00,0x3F,0xFC,0x0F,0xC0,0x08,0x00,
0x00,0x00,0x00,0xFF,0xE1,0xFF,0xFF,0xFF,0xFF,0xE0,0x00,0x0B,0xFF,0x80,0x00,0x00,
0x00,0x00,0x0F,0xFF,0xFF,0xDC,0x0E,0x00,0x00,0x00,0x00,0x7F,0x80,0xFF,0xFF,0xFF
};

/* --- low-level I2C write wrapper --- */
ssize_t i2c_write_bytes(const uint8_t *buf, size_t len) {
    ssize_t ret = write(i2c_fd, buf, len);
    if (ret < 0) {
        perror("i2c write");
    }
    return ret;
}

/* send single command byte to SSD1306 */
void ssd1306_command(uint8_t cmd) {
    uint8_t buf[2] = {0x00, cmd}; // control byte 0x00 = command
    if (i2c_write_bytes(buf, 2) != 2) {
        fprintf(stderr, "Failed to send command 0x%02X\n", cmd);
    }
}

/* initialize SSD1306 for 128x32 */
void ssd1306_init(void) {
    ssd1306_command(0xAE); // Display OFF
    ssd1306_command(0xD5); ssd1306_command(0x80);
    ssd1306_command(0xA8); ssd1306_command(HEIGHT - 1); // multiplex
    ssd1306_command(0xD3); ssd1306_command(0x00);
    ssd1306_command(0x40);
    ssd1306_command(0x8D); ssd1306_command(0x14);
    ssd1306_command(0x20); ssd1306_command(0x00);
    ssd1306_command(0xA1); // seg remap
    ssd1306_command(0xC8); // com scan dec
    ssd1306_command(0xDA); ssd1306_command(0x02);
    ssd1306_command(0x81); ssd1306_command(0xCF);
    ssd1306_command(0xD9); ssd1306_command(0xF1);
    ssd1306_command(0xDB); ssd1306_command(0x40);
    ssd1306_command(0xA4);
    ssd1306_command(0xA6);
    ssd1306_command(0xAF); // Display ON
}

/* clear the display (write 0x00 to all pages) */
void ssd1306_clear(void) {
    uint8_t buf[129];
    buf[0] = 0x40; // control byte: data
    memset(&buf[1], 0x00, 128);

    for (int page = 0; page < (HEIGHT / 8); page++) {
        ssd1306_command(0xB0 + page);
        ssd1306_command(0x00);
        ssd1306_command(0x10);
        if (i2c_write_bytes(buf, sizeof(buf)) != sizeof(buf)) {
            fprintf(stderr, "Failed to clear page %d\n", page);
        }
    }
}

/* draw 128x32 bitmap (array must be page-ordered: page0 col0..127, page1 col0..127, ...) */
void ssd1306_draw_bitmap(const uint8_t *bitmap) {
    uint8_t buf[129];
    buf[0] = 0x40; // data

    for (int page = 0; page < (HEIGHT / 8); page++) {
        ssd1306_command(0xB0 + page); // set page
        ssd1306_command(0x00);        // lower col
        ssd1306_command(0x10);        // higher col

        // copy 128 bytes for this page
        for (int col = 0; col < WIDTH; col++) {
            buf[col+1] = bitmap[page * WIDTH + col];
        }
        if (i2c_write_bytes(buf, sizeof(buf)) != sizeof(buf)) {
            fprintf(stderr, "Failed to write page %d\n", page);
        }
    }
}

int main(void) {
    // open i2c device
    i2c_fd = open(I2C_DEVICE, O_RDWR);
    if (i2c_fd < 0) {
        perror("open " I2C_DEVICE);
        return 1;
    }

    // set slave address
    if (ioctl(i2c_fd, I2C_SLAVE, SSD1306_ADDR) < 0) {
        perror("ioctl I2C_SLAVE");
        close(i2c_fd);
        return 2;
    }

    // Init and display
    ssd1306_init();
    ssd1306_clear();
    ssd1306_draw_bitmap(hanuman_bitmap_rot270);

    // done
    close(i2c_fd);
    return 0;
}

